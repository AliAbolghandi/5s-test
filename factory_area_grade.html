<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>نمودار عملکرد واحدها</title>
  <link rel="stylesheet" href="./library/font/yekan/yekan.css">
  <link rel="stylesheet" href="./library/jalalidatepicker/jalalidatepicker.min.css">
  <script src="./library/jalalidatepicker/jalalidatepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #2944bb;
      --primary-dark2: #091342;
      --secondary: #7209b7;
      --success: #06d6a0;
      --danger: #ef476f;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --border-radius: 12px;
      --box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Yekan', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      direction: rtl;
    }

    #dashboard {
      width: 100%;
      height: 18vh;
      border-radius: 0 0 10px 10px;
      background: var(--primary);
      color: #fff;
      padding: 18px 28px;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--box-shadow);
      text-align: center;
    }

    #dashboard .avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, .3)
    }

    #dashboard .user-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-left: 15px;
      text-align: center;
    }

    .report-text {
      display: flex;
      align-items: center;
      margin-right: 5%;
      flex: 1;
    }

    .btn-logout {
      display: flex;
      align-items: center;
      background: transparent;
      align-items: left;
      border: none;
      cursor: pointer;
      padding-left: 5%;
    }

    .btn-logout:hover {
      transform: translatex(2px);
    }

    .menu-btn {
      font-size: 30px;
      cursor: pointer;
      padding: 10px;
      color: white;
      z-index: 1100;
      position: relative;
    }

    .side-menu {
      height: 100%;
      width: 0;
      position: fixed;
      top: 0;
      left: 0;
      backdrop-filter: blur(12px);
      background: rgba(55, 4, 138, 0.15);
      box-shadow: 2px 0 15px rgba(2, 0, 0, 0.3);
      border-right: 1px solid rgba(49, 8, 233, 0.3);
      overflow-x: hidden;
      transition: 0.3s;
      padding-top: 60px;
      direction: rtl;
      z-index: 1000;
    }

    .side-menu a {
      padding: 12px 25px;
      background-color: rgba(114, 73, 179, 0.15);
      border-radius: 20px;
      text-decoration: none;
      color: #010002;
      display: block;
      transition: 0.2s;
      font-size: 16px;
      margin: 0 10px 10px 10px;
    }

    .side-menu a:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
    }

    #sideMenu a#admin-panel-btn {
      font-weight: bold;
    }

    /* محتوای اصلی */
    .container {
      width: 95%;
      margin: 30px auto;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 30px;
    }

    h2 {
      color: var(--dark);
      margin-bottom: 30px;
      font-size: 24px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    /* انتخابگرها */
    .selectors-wrapper {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }

    .selector-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .selector-container label {
      color: var(--dark);
      font-weight: bold;
      font-size: 16px;
      min-width: 100px;
    }

    .selector-container select {
      padding: 12px 25px;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      font-family: 'Yekan', sans-serif;
      font-size: 14px;
      min-width: 350px;
      transition: var(--transition);
      background: white;
      cursor: pointer;
    }

    .selector-container select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .selector-container select option {
      font-family: 'Yekan', sans-serif;
    }

    /* فیلتر تاریخ */
    .filter-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 30px;
      padding: 20px;
      background: var(--light);
      border-radius: var(--border-radius);
    }

    .filter-container label {
      color: var(--dark);
      font-weight: bold;
      font-size: 14px;
    }

    .filter-container input[type="text"] {
      padding: 10px 15px;
      border: 2px solid #e9ecef;
      border-radius: var(--border-radius);
      font-family: 'Yekan', sans-serif;
      font-size: 14px;
      width: 150px;
      transition: var(--transition);
      text-align: center;
    }

    .filter-container input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
    }

    .filter-container button {
      background: linear-gradient(to top, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: var(--border-radius);
      font-family: 'Yekan', sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--box-shadow);
    }

    .filter-container button:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(67, 97, 238, 0.3);
    }

    .filter-container button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* نمودار */
    .chart-container {
      position: relative;
      height: 400px;
      margin: 20px 0;
      padding: 20px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    /* اطلاعات آماری */
    .stats-container {
      display: flex;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark2));
      color: white;
      padding: 10px 10px 24px 10px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--box-shadow);
    }

    .stat-card #maxScore {
      background: var(--success);
      border-radius: var(--border-radius);

    }
    .stat-card #minScore {
      background: var(--danger);
      border-radius: var(--border-radius);

    }

    .stat-card h3 {
      background: bottom;
      border-radius: var(--border-radius);
      font-size: 16px;
      margin-bottom: 10px;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 16px;
      font-weight: bold;
    }

    #loading {
      text-align: center;
      color: var(--primary);
      margin-top: 40px;
      font-weight: bold;
      font-size: 16px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e9ecef;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 15px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .no-data {
      text-align: center;
      color: var(--gray);
      padding: 50px;
      font-size: 16px;
    }

    /* رسپانسیو */
    @media (max-width: 768px) {
      .container {
        width: 98%;
        padding: 15px;
      }

      .filter-container {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-container input[type="text"] {
        width: 100%;
      }

      .filter-container button {
        width: 100%;
      }

      .selector-container select {
        min-width: 100%;
      }

      .chart-container {
        height: 300px;
      }

      .selectors-wrapper {
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <!-- داشبورد کاربر -->
  <div id="dashboard" style="display: none;">
    <div class="avatar">
      <img src="./img/icon-150-150.png" alt="User Avatar">
    </div>
    <div class="user-info">
      <p class="username">نام کاربر</p>
      <p class="phone"></p>
    </div>

    <!-- دکمه همبرگری -->
    <div id="menuButton" class="menu-btn">&#9776;</div>
    <!-- منو همبرگری -->
    <div id="sideMenu" class="side-menu">
      <P>__________</P>
      <a id="mainpage" href="5s_question.html">صفحه اصلی</a>
      <a id="gozaresh" href="personal_report.html">گزارش ارزیابی من</a>
      <!-- <a id="unitChart" href="unit_chart.html">نمودار عملکرد واحدها</a> -->
      <a id="logout" href="index.html">خروج</a>
    </div>
  </div>

  <div class="container">
    <h2>نمودار عملکرد واحدهای اصلی</h2>

    <div class="selectors-wrapper">
      <!-- انتخاب واحد اصلی -->
      <div class="selector-container">
        <label for="unitSelect">واحد اصلی:</label>
        <select id="unitSelect">
          <option value="">لطفاً یک واحد را انتخاب کنید</option>
        </select>
      </div>

      <!-- انتخاب زیرواحد/قسمت (به صورت پویا نمایش داده می‌شود) -->
      <div class="selector-container" id="subunitContainer" style="display: none;">
        <label for="subunitSelect">قسمت / زیرواحد:</label>
        <select id="subunitSelect">
          <option value="">همه قسمتها</option>
        </select>
      </div>
    </div>

    <!-- فیلتر تاریخ -->
    <div class="filter-container">
      <label>از تاریخ:</label>
      <input type="text" id="startDate" data-jdp placeholder="۱۴۰۳/۰۱/۰۱">

      <label>تا تاریخ:</label>
      <input type="text" id="endDate" data-jdp placeholder="۱۴۰۳/۱۲/۲۹">

      <button onclick="loadChartData()" id="loadDataBtn">
        اعمال فیلتر
      </button>
    </div>

    <!-- لودینگ -->
    <div id="loading" style="display: none;">
      <div class="loading-spinner"></div>
      در حال بارگذاری اطلاعات...
    </div>

    <!-- نمودار -->
    <div class="chart-container" id="chartContainer" style="display: none;">
      <canvas id="performanceChart"></canvas>
    </div>

    <!-- آمار -->
    <div class="stats-container" id="statsContainer" style="display: none;">

      <div class="stat-card">
        <h3 >بیشترین امتیاز</h3>
        <div class="value" id="maxScore">۰</div>
      </div>
      <div class="stat-card">
        <h3>کمترین امتیاز</h3>
        <div class="value" id="minScore">۰</div>
      </div>
      <div class="stat-card">
        <h3>میانگین امتیاز</h3>
        <div class="value" id="avgScore">۰</div>
      </div>
      <div class="stat-card">
        <h3>تعداد ارزیابی‌ها</h3>
        <div class="value" id="totalCount">۰</div>
      </div>
    </div>

    <!-- پیام عدم وجود داده -->
    <div id="noDataMessage" class="no-data" style="display: none;">
      هیچ داده‌ای برای این واحد در بازه زمانی انتخاب شده وجود ندارد.
    </div>
  </div>

  <script>
    // فعال‌سازی jalali datepicker
    jalaliDatepicker.startWatch();

    // منوی همبرگری
    const menuButton = document.getElementById("menuButton");
    const sideMenu = document.getElementById("sideMenu");

    menuButton.addEventListener("click", (event) => {
      event.stopPropagation();
      if (sideMenu.style.width === "250px") {
        sideMenu.style.width = "0";
      } else {
        sideMenu.style.width = "250px";
      }
    });

    document.addEventListener("click", (event) => {
      if (sideMenu.style.width === "250px" &&
        !sideMenu.contains(event.target) &&
        !menuButton.contains(event.target)) {
        sideMenu.style.width = "0";
      }
    });

    sideMenu.addEventListener("click", (event) => {
      event.stopPropagation();
    });

    // بارگذاری اطلاعات کاربر
    document.addEventListener("DOMContentLoaded", () => {
      const name = localStorage.getItem("name") || "نام";
      const family = localStorage.getItem("family") || "نام‌خانوادگی";

      document.querySelector("#dashboard .username").textContent =
        name + " " + family + " عزیز خوش آمدید ";

      const role = localStorage.getItem("access");
      if (role && role.toUpperCase() === "ADMIN") {
        const adminBtn = document.createElement("a");
        adminBtn.href = "adminstration.html";
        adminBtn.textContent = "داشبورد مدیریت ";
        adminBtn.id = "admin-panel-btn";

        const logoutBtn = document.getElementById("logout");
        sideMenu.insertBefore(adminBtn, logoutBtn);
      }

      // بارگذاری لیست واحدها
      loadUnitsList();

      // تنظیم پیش‌فرض تاریخ به سال جاری
      const today = new Date();
      const persianDate = jalaliDatepicker.getMoment(today);
      const startOfYear = `${persianDate.jy}/01/01`;
      const endOfYear = `${persianDate.jy}/12/29`;

      document.getElementById('startDate').value = startOfYear;
      document.getElementById('endDate').value = endOfYear;
    });

    // URL های داده
    const scoreSheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLQOZ1BULWMd-hYLNbp27FLhXSqic2zBD9Vw7w29BzzoTrwJliUAoRmVVKBWTdQq846up09UdiYLyc/pub?gid=326213833&single=true&output=csv";
    const unitSheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRLQOZ1BULWMd-hYLNbp27FLhXSqic2zBD9Vw7w29BzzoTrwJliUAoRmVVKBWTdQq846up09UdiYLyc/pub?gid=0&single=true&output=csv";

    // متغیرهای سراسری
    let unitSubunitMap = {}; // نگاشت واحدها به زیرواحدها
    let allUnits = [];
    let chartInstance = null;

    // توابع کمکی
    function toNumber(value) {
      return parseFloat(value) || 0;
    }

    function parseCSV(text) {
      return text.trim().split("\n").map(r => r.split(","));
    }

    function jalaliToNumber(jDate) {
      if (!jDate) return 0;
      return parseInt(jDate.replaceAll("/", ""));
    }

    function toPersianNumber(str) {
      const persianDigits = ["۰", "۱", "۲", "۳", "۴", "۵", "۶", "۷", "۸", "۹"];
      return str.toString().replace(/\d/g, d => persianDigits[d]);
    }

    function formatNumber(num) {
      return toPersianNumber(num.toFixed(2));
    }

    function getMonthName(month) {
      const monthNames = [
        'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
        'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
      ];
      return monthNames[month - 1];
    }

    // بارگذاری لیست واحدها و زیرواحدها
    async function loadUnitsList() {
      try {
        const unitCSV = await fetch(unitSheetURL).then(r => r.text());
        const unitRows = parseCSV(unitCSV).slice(1); // حذف هدر

        const unitsSet = new Set();
        unitSubunitMap = {};

        unitRows.forEach(row => {
          if (row.length < 2) return; // بررسی وجود حداقل 2 ستون

          const unit = row[0]?.trim();
          const subunit = row[1]?.trim(); // ستون دوم = زیرواحد/قسمت

          if (unit && subunit) {
            unitsSet.add(unit);
            if (!unitSubunitMap[unit]) {
              unitSubunitMap[unit] = new Set();
            }
            unitSubunitMap[unit].add(subunit);
          }
        });

        allUnits = [...unitsSet].sort();
        const unitSelect = document.getElementById('unitSelect');
        unitSelect.innerHTML = '<option value="">لطفاً یک واحد را انتخاب کنید</option>';

        allUnits.forEach(unit => {
          const option = document.createElement('option');
          option.value = unit;
          option.textContent = unit;
          unitSelect.appendChild(option);
        });

        // غیرفعال کردن دکمه اعمال فیلتر تا زمانی که واحد انتخاب شود
        document.getElementById('loadDataBtn').disabled = true;

      } catch (err) {
        console.error('خطا در بارگذاری لیست واحدها:', err);
        alert('خطا در بارگذاری لیست واحدها. لطفاً صفحه را بازخوانی کنید.');
      }
    }

    // رویداد تغییر واحد اصلی
    document.getElementById('unitSelect').addEventListener('change', function () {
      const selectedUnit = this.value;
      const subunitContainer = document.getElementById('subunitContainer');
      const subunitSelect = document.getElementById('subunitSelect');
      const loadBtn = document.getElementById('loadDataBtn');

      if (selectedUnit && unitSubunitMap[selectedUnit]) {
        // پاک کردن گزینه‌های قبلی
        subunitSelect.innerHTML = '<option value="">همه قسمتها</option>';

        // اضافه کردن زیرواحدهای مربوط به واحد انتخاب شده
        const subunits = [...unitSubunitMap[selectedUnit]].sort();
        subunits.forEach(subunit => {
          const option = document.createElement('option');
          option.value = subunit;
          option.textContent = subunit;
          subunitSelect.appendChild(option);
        });

        subunitContainer.style.display = 'flex'; // نمایش فیلتر
        loadBtn.disabled = false; // فعال کردن دکمه
      } else {
        subunitContainer.style.display = 'none'; // مخفی کردن فیلتر
        loadBtn.disabled = !selectedUnit; // اگر واحدی انتخاب نشده، دکمه غیرفعال باشد
      }
    });

    // بارگذاری داده‌های نمودار
    async function loadChartData() {
      const unit = document.getElementById('unitSelect').value;
      if (!unit) {
        alert('لطفاً یک واحد را انتخاب کنید.');
        return;
      }

      const subunit = document.getElementById('subunitSelect').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      // اعتبارسنجی تاریخ‌ها
      if (!startDate || !endDate) {
        alert('لطفاً تاریخ شروع و پایان را وارد کنید.');
        return;
      }

      const startDateNum = jalaliToNumber(startDate);
      const endDateNum = jalaliToNumber(endDate);

      if (startDateNum > endDateNum) {
        alert('تاریخ شروع نباید بزرگتر از تاریخ پایان باشد.');
        return;
      }

      // نمایش لودینگ
      document.getElementById('loading').style.display = 'block';
      document.getElementById('chartContainer').style.display = 'none';
      document.getElementById('statsContainer').style.display = 'none';
      document.getElementById('noDataMessage').style.display = 'none';
      document.getElementById('loadDataBtn').disabled = true;

      try {
        const scoreCSV = await fetch(scoreSheetURL).then(r => r.text());
        const scoreRows = parseCSV(scoreCSV);
        const headers = scoreRows[0];
        const data = scoreRows.slice(1);

        // پیدا کردن ایندکس ستون‌ها
        const dateIndex = 0;
        const unitIndex = headers.indexOf("واحد اصلی");
        const subunitIndex = headers.indexOf("قسمت"); // بر اساس نام ستون در شیت امتیازات
        const s1Index = headers.indexOf("S1");
        const s2Index = headers.indexOf("S2");
        const s3Index = headers.indexOf("S3");
        const s4Index = headers.indexOf("S4");
        const s5Index = headers.indexOf("S5");

        // بررسی وجود ستون‌های مورد نیاز
        if (unitIndex === -1 || subunitIndex === -1) {
          throw new Error("ستون‌های مورد نیاز در داده‌ها یافت نشد.");
        }

        // گروه‌بندی داده‌ها بر اساس ماه
        const monthlyData = {};

        data.forEach(row => {
          const rowUnit = row[unitIndex]?.trim();
          if (rowUnit !== unit) return;

          // اعمال فیلتر زیرواحد اگر انتخاب شده باشد
          const rowSubunit = row[subunitIndex]?.trim();
          if (subunit && rowSubunit !== subunit) return;

          const rowDate = row[dateIndex];
          const rowDateNum = jalaliToNumber(rowDate);

          if (rowDateNum < startDateNum || rowDateNum > endDateNum) return;

          // استخراج سال و ماه از تاریخ شمسی
          const dateParts = rowDate.split('/');
          if (dateParts.length < 2) return;

          const [year, month] = dateParts.map(Number);
          const monthKey = `${year}/${month}`;

          if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = {
              count: 0,
              total: 0,
              scores: []
            };
          }

          const s1 = toNumber(row[s1Index]);
          const s2 = toNumber(row[s2Index]);
          const s3 = toNumber(row[s3Index]);
          const s4 = toNumber(row[s4Index]);
          const s5 = toNumber(row[s5Index]);

          const totalScore = s1 + s2 + s3 + s4 + s5;

          monthlyData[monthKey].count++;
          monthlyData[monthKey].total += totalScore;
          monthlyData[monthKey].scores.push(totalScore);
        });

        // مرتب‌سازی ماه‌ها
        const sortedMonths = Object.keys(monthlyData).sort((a, b) => {
          const [yearA, monthA] = a.split('/').map(Number);
          const [yearB, monthB] = b.split('/').map(Number);
          if (yearA !== yearB) return yearA - yearB;
          return monthA - monthB;
        });

        if (sortedMonths.length === 0) {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('noDataMessage').style.display = 'block';
          document.getElementById('loadDataBtn').disabled = false;
          return;
        }

        // محاسبه میانگین‌ها
        const averages = sortedMonths.map(monthKey => {
          const data = monthlyData[monthKey];
          return data.total / data.count;
        });

        // محاسبه آمار
        const allScores = Object.values(monthlyData).flatMap(d => d.scores);
        const avgScore = allScores.reduce((a, b) => a + b, 0) / allScores.length;
        const maxScore = Math.max(...allScores);
        const minScore = Math.min(...allScores);
        const totalCount = allScores.length;

        // بروزرسانی آمار
        document.getElementById('avgScore').textContent = formatNumber(avgScore);
        document.getElementById('maxScore').textContent = formatNumber(maxScore);
        document.getElementById('minScore').textContent = formatNumber(minScore);
        document.getElementById('totalCount').textContent = toPersianNumber(totalCount);

        // ایجاد برچسب‌های ماه‌ها
        const labels = sortedMonths.map(monthKey => {
          const [year, month] = monthKey.split('/').map(Number);
          return `${getMonthName(month)} ${year}`;
        });

        // نمایش یا آپدیت نمودار
        const ctx = document.getElementById('performanceChart').getContext('2d');

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: subunit ? `میانگین امتیاز - ${subunit}` : 'میانگین امتیاز',
              data: averages,
              borderColor: 'var(--primary)',
              backgroundColor: 'rgba(67, 97, 238, 0.1)',
              borderWidth: 3,
              pointBackgroundColor: 'var(--primary-dark)',
              pointBorderColor: 'white',
              pointBorderWidth: 2,
              pointRadius: 6,
              pointHoverRadius: 8,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                rtl: true,
                titleFont: {
                  family: 'Yekan'
                },
                bodyFont: {
                  family: 'Yekan'
                },
                callbacks: {
                  label: function (context) {
                    return `میانگین امتیاز: ${toPersianNumber(context.raw.toFixed(2))}`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  font: {
                    family: 'Yekan'
                  },
                  callback: function (value) {
                    return toPersianNumber(value.toFixed(1));
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    family: 'Yekan'
                  },
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            }
          }
        });

        // نمایش المان‌ها
        document.getElementById('loading').style.display = 'none';
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('statsContainer').style.display = 'grid';
        document.getElementById('loadDataBtn').disabled = false;

      } catch (err) {
        document.getElementById('loading').style.display = 'none';
        alert('خطا در بارگذاری داده‌ها: ' + err.message);
        console.error(err);
        document.getElementById('loadDataBtn').disabled = false;
      }
    }
  </script>
</body>

</html>